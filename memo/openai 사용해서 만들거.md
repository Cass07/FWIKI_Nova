1. batch
   - 실시간으로 처리할 필요가 없으므로 batch 사용
   - 아마도? 제일 처음에만 프롬프트 보내면 나머지는 안써도 될거같?음
   - jsonl 파일을 생성해서 업로드하는 과정 필요
   - batch 결과 또한 jsonl 파일로 제공되는 것으로 보임
   
2. webhook
   - batch 완료 시 웹후크를 발생시켜서 처리 완료된걸 바로 확인할 수 있게 함
   - 웹후크 발생하면 처리 완료된 응답 id를 알려줌
   - 웹훅 엔드포인트 호출 시 보안을 위해 secret을 같이 전송해줌
     - OpenAI SDK를 사용해서 확인할 수도 있고
     - 문서 보고 구현해도 되고
     - https://github.com/standard-webhooks/standard-webhooks/blob/main/spec/standard-webhooks.md#verifying-webhook-authenticity

3. 대충 플로우
   - batch 보내는거
     - 1주일 이상 지난 데이터중에 제일 최신 데이터 n개 묶음
       - 이미 batch 처리 보냈는데 응답이 오지 않은 데이터는 제외해야 함
       - 대사가 일부 추가되서 일부만 미번역인 경우는?? 그 일부만 보내면 될것같음
     - 그 뒤로는 json으로 데이터 정리
     - jsonl로 묶음
     - 파일 업로드 (openai)
     - batch 요청
     - 데이터를 묶고 처리하는 동안의 새로이 추가되는 데이터는 신경쓰지 않음(사용자 경험 문제).
       - 데이터를 보내고 받는 사이에 사용자 데이터가 입력된다면, 이는 받은 데이터를 처리하는 시점에 핸들링하는 것으로 한다
     - 단, 수동으로 배치를 실행할 때 동시에 여러번 실행된다면, 그건 막아야함
       - 배치 시작 시 작업의 데이터를 테이블에 저장하므로, 현재 처리가 왼료되지 않은 작업 데이터가 있다면
         - 작업 데이터만 삽입해서 작업을 예약하자
           - 그렇다면 한번에 3개 이상의 호출이 몰렸다면? 예약된 순서대로 처리하자
           - 그렇다면 아예 배치 시작 시 작업을 예약만 하고 순차적으로 처리하도록 하면 되는거아닌가??
   - 처리되지 않은 batch 데이터 처리
     - batch 최대 24시간까지 지연될수잇음 (그뒤로오면 처리 실패된것)
     - 24시간이 지났는데 성공하지 못한 요청 데이터는 삭제
   - webhook 엔드포인트 실행 시
     - jsonl 파일을 받음
     - 각 json의 데이터 검증
       - 실패시 받은 데이터를 에러 모니터링에 기록
       - exception 발생시키고 slack 메시지 전송
     - 풀어서 work id별로 작업을하는데
       - 요청을 보내고 받는 사이에 손번역 데이터가 추가되었다면?
         - 데이터를 새로 입력하되 반려 데이터로 저장할것
       - 그 이외에 경우에는 그냥 새로 추가하면 문제없음
     - 동기처리하면 오래걸리니까 비동기로 처리하기
     - 각 배치잡의 데이터 셋은 중복되지 않음을 호출 때 보장하긴 하는데... 혹시 중복되면 어캄?

4. DB 테이블 설계
   - batch list 요청 정보 테이블
     - 요청의 묶음인 batch에 관한 정보
     - batch id
     - 요청 시간
     - 상태
   - batch 요청 정보 테이블
     - (batch 내의 각각의 json 요청 정보에 관한 테이블임)
     - batch id (묶음 batch에 관한 정보)
     - hero id
     - 요청 시간
     - 상태
   - batch 결과 저장 테이블
     - hero id
     - 결과 수집 시간
     - json raw data
     - raw 데이터는 로깅만 해도 되지 않을라나?? 일단 테이블에 저장해봄

5. 기타
   - 데이터 처리할 때 flux 사용해서 비동기 처리하고
   - 데이터를 삽입할 때는 여러개 묶어서 한번에 insert 요청 넣도록 하기

6. file upload
   - json 생성하고 이걸 배열로 만들어서 \n으로 이어붙이면 jsonl이 됨
   - byte배열로 전송해도 된다고함


7. batch 작업의 예약